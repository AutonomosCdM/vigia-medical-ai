# VIGIA Medical AI - Entity States

## Objetivo
Estados críticos del dominio médico: ciclo de vida de sesiones médicas, estados de análisis de agentes y transiciones de emergencia para compliance.

## Código Eraser.io
```
autoNumber on
colorMode bold

// Medical Session Lifecycle
Session [icon: clock, color: blue]
PHI_Tokenizer [icon: shield, color: red]
Master_Orchestrator [icon: hub, color: purple]
Medical_Agents [icon: users, color: green]
Medical_Team [icon: users, color: orange]
Patient [icon: user, color: blue]

// Phase 1: Session Creation
Patient > Session: "🏥 Medical case initiated"
activate Session
Session > PHI_Tokenizer: "Create Batman token"
activate PHI_Tokenizer

alt [label: "PHI Tokenization Success"] {
  PHI_Tokenizer > Session: "✅ Token: batman_TC001\n⏱️ 15min timeout"
  Session > Session: "State: ACTIVE\n🟢 Ready for processing"
}
else [label: "PHI Tokenization Failed"] {
  PHI_Tokenizer > Session: "❌ Tokenization failed"
  Session > Session: "State: FAILED\n🔴 Invalid patient data"
  Session > Patient: "❌ Unable to process"
  deactivate Session
}
deactivate PHI_Tokenizer

// Phase 2: Medical Processing States
Session > Master_Orchestrator: "🚀 Begin medical analysis"
activate Master_Orchestrator
Master_Orchestrator > Session: "State: PROCESSING\n🟡 Agents coordinating"

// Agent Analysis States
Master_Orchestrator > Medical_Agents: "Coordinate 9-agent analysis"
activate Medical_Agents

par [label: "Agent Processing States"] {
  Medical_Agents > Medical_Agents: "Image Agent: ANALYZING\n🔍 MONAI processing..."
}
and {
  Medical_Agents > Medical_Agents: "Clinical Agent: ASSESSING\n🩺 Risk evaluation..."
}
and {
  Medical_Agents > Medical_Agents: "Protocol Agent: REVIEWING\n📋 NPUAP guidelines..."
}

// Critical Decision Point
alt [label: "High Confidence Analysis (>90%)"] {
  Medical_Agents > Master_Orchestrator: "✅ Analysis: COMPLETE\n🎯 Confidence: 94%"
  Master_Orchestrator > Session: "State: ANALYZED\n🟢 High confidence results"
}
else [label: "Low Confidence Analysis (<80%)"] {
  Medical_Agents > Master_Orchestrator: "⚠️ Analysis: UNCERTAIN\n🎯 Confidence: 76%"
  Master_Orchestrator > Session: "State: REQUIRES_REVIEW\n🟡 Human review needed"
}
else [label: "Critical Emergency Detected"] {
  Medical_Agents > Master_Orchestrator: "🚨 Analysis: EMERGENCY\n⚠️ Grade 4 LPP detected"
  Master_Orchestrator > Session: "State: EMERGENCY\n🔴 Immediate action required"
}

deactivate Medical_Agents

// Phase 3: Medical Team Coordination
alt [label: "Emergency State"] {
  Master_Orchestrator > Medical_Team: "🚨 URGENT: Grade 4 LPP\n⏰ <15min response required"
  activate Medical_Team
  Medical_Team > Session: "State: EMERGENCY_ESCALATED\n👨‍⚕️ Dr. Smith responding"
  Session > Session: "Priority: CRITICAL\n⏱️ Extend timeout to 30min"
}
else [label: "Normal Analysis"] {
  Master_Orchestrator > Medical_Team: "📊 Analysis complete\n✅ Results available"
  activate Medical_Team
  Medical_Team > Session: "State: TEAM_NOTIFIED\n📋 Standard review process"
}

deactivate Master_Orchestrator

// Phase 4: Patient Communication States
Medical_Team > Patient: "Medical results transmission"
activate Patient

alt [label: "Emergency Communication"] {
  Patient > Session: "State: EMERGENCY_COMMUNICATED\n🚨 Urgent care instructions sent"
}
else [label: "Standard Communication"] {
  Patient > Session: "State: RESULTS_DELIVERED\n✅ Standard results provided"
}

// Phase 5: Session Completion
Session > Session: "State: COMPLETED\n📋 Medical case closed"

// Audit Trail Completion
Session > Session: "Audit: LOGGED\n🔒 HIPAA compliance verified"
deactivate Medical_Team
deactivate Patient

// Timeout Handling
par [label: "Session Timeout Management"] {
  loop [label: "Every 5 minutes"] {
    Session > Session: "Check session timeout\n⏱️ Current: 12min remaining"
    
    alt [label: "Timeout Warning (5min left)"] {
      Session > Patient: "⚠️ Session expires in 5min\n🔄 Extend if needed"
    }
    else [label: "Session Expired"] {
      Session > Session: "State: EXPIRED\n🔴 Session terminated"
      Session > PHI_Tokenizer: "🗑️ Cleanup Batman token"
      deactivate Session
    }
  }
}

// State Transition Summary
note over Session, Patient: "📊 SESSION STATES:\n🟢 ACTIVE → PROCESSING → ANALYZED\n🟡 REQUIRES_REVIEW → TEAM_NOTIFIED\n🔴 EMERGENCY → EMERGENCY_ESCALATED\n✅ COMPLETED → EXPIRED"
```

## Notas Clave
- **15-min Session Timeout**: Seguridad PHI con extensión automática para emergencias críticas
- **Emergency State Machine**: Grade 4 LPP → immediate escalation con timeout extendido a 30min
- **9-Agent Coordination**: Estados paralelos de análisis con confidence thresholds
- **Complete Audit Trail**: Cada transición de estado registrada para HIPAA compliance

## Para Editar
1. Copia el código anterior
2. Ve a [eraser.io](https://eraser.io)
3. Crea nuevo diagrama → Diagram-as-code
4. Pega el código y edita